<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nutrition Calculator — KISS Wireframe v4</title>
<style>
  :root{ --bg:#0b0f12; --card:#12181d; --edge:#22303c; --ink:#e7eef6; --muted:#95a3b1; --accent:#22c55e; --chip:#0f1a13; }
  *{box-sizing:border-box}
  body{margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--ink);}
  a{color:var(--accent); text-decoration:none}
  a:hover{text-decoration:underline}
  header{display:flex; align-items:center; gap:10px; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--edge); position:sticky; top:0; background:rgba(11,15,18,.92); backdrop-filter: blur(6px); z-index:100}
  .tabs{display:flex; gap:6px; flex-wrap:wrap}
  .tab{padding:8px 12px; border:1px solid var(--edge); border-radius:10px; cursor:pointer; background:#0f1419}
  .tab.active{background:#132019; border-color:#2a5e3e}
  .wrap{max-width:1000px; margin:0 auto; padding:16px; display:grid; gap:12px;}
  .card{background:var(--card); border:1px solid var(--edge); border-radius:12px; padding:14px}
  h2{margin:0 0 8px 0; font-size:13px; text-transform:uppercase; color:#b7c3cf; letter-spacing:.12em}
  label{font-size:12px; color:#b7c3cf}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .input, select{width:100%; padding:10px; border:1px solid var(--edge); border-radius:10px; background:#0f1419; color:#e7eef6;}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .pill{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border:1px solid var(--edge); border-radius:999px; color:#b7c3cf; background:#0f1419; font-size:12px}
  .btn{appearance:none; padding:8px 12px; border-radius:10px; border:1px solid var(--edge); background:#0f1419; color:#e7eef6; cursor:pointer; font-weight:600}
  .btn.primary{background:var(--accent); border-color:#1daa55; color:#072012}
  .hint{color:#9fb0bf; font-size:12px}
  .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  .kpi .box{background:#0f1419; border:1px dashed var(--edge); border-radius:10px; padding:10px}
  .kpi .box big{display:block; font-size:18px; font-weight:700}
  .section{display:none}
  .section.active{display:block}
  .hr{height:1px; background:var(--edge); margin:10px 0}
  .flag{padding:10px; border:1px solid var(--edge); border-radius:10px; background:#0f1419; color:#cdd6df}
  ul{margin:6px 0 0 16px}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:8px; font-size:12px; background:var(--chip); border:1px solid #173225; color:#9fd4b2}
  .accordion{display:grid; gap:10px}
  .acc{border:1px solid var(--edge); border-radius:12px; overflow:hidden; background:#0f1419}
  .acc h3{margin:0; padding:12px 14px; font-size:14px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; color:#d9e4ee}
  .acc .content{display:none; padding:0 14px 14px 14px}
  .acc.open .content{display:block}
  table{width:100%; border-collapse:collapse; margin-top:8px; font-size:13px}
  th,td{border-bottom:1px solid var(--edge); padding:6px 8px; text-align:left}
  th{color:#b7c3cf; font-weight:600}
  .buy a{display:inline-flex; align-items:center; gap:6px}
  .ext:before{content:"↗"; font-size:12px; opacity:.8}
  .chipnote{font-size:12px; color:#b7c3cf; background:#111920; border:1px solid var(--edge); padding:8px 10px; border-radius:10px}
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>Nutrition Calculator</strong>
    <span class="pill">KISS wireframe v4</span>
  </div>
  <div class="tabs">
    <div class="tab" data-tab="scale">Scale Recipe</div>
    <div class="tab" data-tab="combine">Combine & Options</div>
    <div class="tab" data-tab="race">Race Day → Batch</div>
    <div class="tab active" data-tab="about">About / Learn</div>
  </div>
  <div class="row">
    <button class="btn" id="btnTemplates">Templates</button>
    <button class="btn primary" id="btnExport">Export PDF</button>
  </div>
</header>

<div class="wrap">

  <!-- SCALE RECIPE (copied from v3) -->
  <section class="section" id="sec-scale">
    <div class="card">
      <h2>Recipe (per serving)</h2>
      <div class="grid3">
        <div>
          <label>Mode</label>
          <select id="mode" class="input">
            <option value="custom">Custom (glucose/malto + fructose)</option>
            <option value="cane">Ultra-Simple Cane Sugar</option>
          </select>
        </div>
        <div>
          <label>Total carbs (g)</label>
          <input id="rCHO" class="input" type="number" value="24" />
        </div>
        <div>
          <label>Caffeine (mg)</label>
          <input id="rCaf" class="input" type="number" value="0" />
        </div>
      </div>

      <div class="grid3" id="ratioRow">
        <div>
          <label>Glucose/Malto : Fructose</label>
          <input id="ratio" class="input" value="1 : 0.8" />
        </div>
        <div>
          <label>Gelling? (alginate/LM/xanthan)</label>
          <select id="gel" class="input">
            <option>None</option>
            <option>Alginate + Ca</option>
            <option>LM Pectin + Ca</option>
            <option>Xanthan (thick)</option>
          </select>
        </div>
        <div>
          <label>Water % (if gel)</label>
          <input id="rWater" class="input" type="number" value="62.5" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid3">
        <div>
          <label>Sodium source</label>
          <select id="naSource" class="input" title="Pick where sodium comes from">
            <option value="blend">Electrolyte blend (1000 mg Na / 4.8 g)</option>
            <option value="salt">Sea salt (NaCl)</option>
          </select>
          <div class="hint">Blend ≈ 208.33 mg Na per gram. Sea salt ≈ 393 mg Na per gram.</div>
        </div>
        <div>
          <label>Target sodium / serving (mg)</label>
          <input id="rNa" class="input" type="number" value="500" />
        </div>
        <div>
          <label>Per serving → grams source</label>
          <input id="rNaGrams" class="input" readonly value="—" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid3">
        <div>
          <label>Units to make</label>
          <input id="units" class="input" type="number" value="10" />
        </div>
        <div>
          <label>Overage % (extra for batch loss)</label>
          <input id="over" class="input" type="number" value="25" />
        </div>
        <div>
          <label>Net fill per unit</label>
          <input id="fill" class="input" value="45 g (gel) or 500 mL (drink)" />
        </div>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="box">
          <small>Per serving split</small>
          <big id="kSplit">13.3g G / 10.7g F</big>
        </div>
        <div class="box">
          <small>Sodium source per serving</small>
          <big id="kNaPer">1.25 g (sea salt)</big>
        </div>
        <div class="box">
          <small>Total sodium / batch</small>
          <big id="kNaBatch">~ 6,250 mg</big>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Batch Ingredients</h2>
      <div class="flag" id="outScale">Enter values above to see computed batch amounts…</div>
    </div>
  </section>

  <!-- COMBINE -->
  <section class="section" id="sec-combine">
    <div class="card">
      <h2>Combine gel/drink + electrolytes / caffeine</h2>
      <div class="grid2">
        <div>
          <label>Base</label>
          <select id="cBase" class="input">
            <option>Gel (custom ratio)</option>
            <option>Drink 320-style</option>
            <option>Drink used as gel (concentrated)</option>
          </select>
        </div>
        <div>
          <label>Include</label>
          <div class="row">
            <label><input type="checkbox" id="cSalt" checked /> Salt/Electrolytes</label>
            <label><input type="checkbox" id="cCaf" /> Caffeine</label>
            <label><input type="checkbox" id="cBicarb" /> Bicarb (drink)</label>
            <label><input type="checkbox" id="cGel" /> Gelling agent</label>
          </div>
        </div>
      </div>
      <div class="grid3" style="margin-top:8px">
        <div>
          <label>Target Na / serving (mg)</label>
          <input id="cNa" class="input" type="number" value="500" />
        </div>
        <div>
          <label>Caffeine / serving (mg)</label>
          <input id="cCafMg" class="input" type="number" value="0" />
        </div>
        <div>
          <label>Water % (if gel)</label>
          <input id="cWater" class="input" type="number" value="62.5" />
        </div>
      </div>
      <div class="hr"></div>
      <div class="flag" id="outCombine">Set options to see simple per-serving amounts (illustrative)…</div>
    </div>
  </section>

  <!-- RACE DAY -->
  <section class="section" id="sec-race">
    <div class="card">
      <h2>Race Day Planner → Batch</h2>
      <div class="grid3">
        <div>
          <label>Distance or time</label>
          <input id="rdDist" class="input" placeholder="Half Marathon or 1:45:00" value="Half Marathon" />
        </div>
        <div>
          <label>Target time (hh:mm:ss)</label>
          <input id="rdTime" class="input" value="1:45:00" />
        </div>
        <div>
          <label>Carbs per hour (g/h)</label>
          <input id="rdChoH" class="input" type="number" value="80" />
        </div>
      </div>
      <div class="grid3" style="margin-top:8px">
        <div>
          <label>Sodium per hour (mg/h)</label>
          <input id="rdNaH" class="input" type="number" value="800" />
        </div>
        <div>
          <label>Gels desired total</label>
          <input id="rdGels" class="input" type="number" value="6" />
        </div>
        <div>
          <label>Per-gel carbs (g)</label>
          <input id="rdChoPerGel" class="input" type="number" value="24" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="rdCompute">Compute plan → recipe</button>
        <span class="hint">Creates a batch spec for the gels you need (with overage).</span>
      </div>
    </div>
    <div class="card">
      <h2>Race Batch Output</h2>
      <div class="flag" id="outRace">Fill inputs and compute to see total gels, Na, and ingredient grams…</div>
    </div>
  </section>

  <!-- ABOUT / LEARN -->
  <section class="section active" id="sec-about">
    <div class="card">
      <h2>About this tool</h2>
      <p class="chipnote">Scale your recipes to any batch, choose sodium source, and plan race-day fueling. This tab explains <b>what each recipe is</b>, <b>why each ingredient is used</b>, and links to supplies. Click “Use This Recipe” to prefill the calculator.</p>
    </div>

    <div class="card">
      <h2>Recipes</h2>
      <div class="accordion">

        <div class="acc" id="acc-100">
          <h3><span>100‑Style Gel (glucose + fructose, no sodium)</span><span>▸</span></h3>
          <div class="content">
            <p><span class="badge">When</span> Shorter races or frequent dosing every 20–30 min.</p>
            <p><b>Composition</b>: glucose : fructose = <b>1 : 0.8</b>, ~<b>24 g carbs</b> per gel, ~<b>62.5% water</b>, <b>alginate + calcium gluconate</b> gel system, <u>no sodium</u> by default.</p>
            <table>
              <thead><tr><th>Ingredient</th><th>Purpose</th><th class="buy">Buy</th></tr></thead>
              <tbody>
                <tr><td>Glucose (dextrose)</td><td>Rapid carb absorption</td><td class="buy"><a href="[[LINK_GLUC]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Fructose</td><td>Dual transporter for higher total uptake</td><td class="buy"><a href="[[LINK_FRUC]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Sodium alginate</td><td>Hydrogel polymer</td><td class="buy"><a href="[[LINK_ALGINATE]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Calcium gluconate</td><td>Crosslinker for gel structure</td><td class="buy"><a href="[[LINK_CAGLU]]" target="_blank" class="ext">Amazon</a></td></tr>
              </tbody>
            </table>
            <div class="row" style="margin-top:8px">
              <button class="btn primary" data-use="r100">Use This Recipe</button>
            </div>
          </div>
        </div>

        <div class="acc" id="acc-320">
          <h3><span>320‑Style Drink Mix / Bulk Powder</span><span>▸</span></h3>
          <div class="content">
            <p><span class="badge">When</span> Long runs/races; 80 g carbs per 500 mL; can also be mixed as a gel or kept as powder.</p>
            <p><b>Core composition</b>: <b>maltodextrin : fructose = 1 : 0.8</b>, plus <b>sodium alginate</b> + <b>LM pectin</b> + <b>sodium bicarbonate</b>. <u>No calcium</u> in drink/powder form. Optional sodium via sea salt or your electrolyte blend.</p>
            <table>
              <thead><tr><th>Ingredient</th><th>Purpose</th><th class="buy">Buy</th></tr></thead>
              <tbody>
                <tr><td>Maltodextrin</td><td>Primary glucose polymer; low sweetness</td><td class="buy"><a href="[[LINK_MALTO]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Fructose</td><td>Secondary carb; raises total uptake</td><td class="buy"><a href="[[LINK_FRUC]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Sodium alginate</td><td>Hydrogel polymer (acid-triggered)</td><td class="buy"><a href="[[LINK_ALGINATE]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>LM pectin</td><td>Co‑polymer for structure & stability</td><td class="buy"><a href="[[LINK_LMPECTIN]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Sodium bicarbonate</td><td>Raises pH to prevent early gelation</td><td class="buy"><a href="[[LINK_BICARB]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Sea salt / Electrolyte blend (optional)</td><td>Sodium (if not added separately)</td><td class="buy"><a href="[[LINK_SALT]]" target="_blank" class="ext">Sea salt</a> · <a href="[[LINK_BLEND]]" target="_blank" class="ext">Blend</a></td></tr>
              </tbody>
            </table>
            <div class="row" style="margin-top:8px">
              <button class="btn primary" data-use="r320drink">Use as Drink (80g/500mL)</button>
              <button class="btn" data-use="r320powder">Use as Bulk Powder</button>
            </div>
          </div>
        </div>

        <div class="acc" id="acc-320gel">
          <h3><span>320‑Style Gel (from 320 powder)</span><span>▸</span></h3>
          <div class="content">
            <p><span class="badge">When</span> You want 320-style carbs with minimal fluid (squeeze gel).</p>
            <p><b>Mix</b>: <b>25 g 320 powder + 15 g water → ~40 g gel</b> delivering ~<b>25 g carbs</b>. Add <b>calcium gluconate</b> to enable gel structure; sodium optional.</p>
            <table>
              <thead><tr><th>Ingredient</th><th>Purpose</th><th class="buy">Buy</th></tr></thead>
              <tbody>
                <tr><td>320 bulk powder</td><td>Provides maltodextrin + fructose + alginate + LM pectin + bicarb</td><td class="buy"><a href="#acc-320" class="ext">See above</a></td></tr>
                <tr><td>Calcium gluconate</td><td>Crosslinker: converts mix to gel</td><td class="buy"><a href="[[LINK_CAGLU]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Water</td><td>Texture control (~37.5% of gel mass)</td><td class="buy">—</td></tr>
                <tr><td>Sodium (optional)</td><td>Sea salt or electrolyte blend</td><td class="buy"><a href="[[LINK_SALT]]" target="_blank" class="ext">Sea salt</a> · <a href="[[LINK_BLEND]]" target="_blank" class="ext">Blend</a></td></tr>
              </tbody>
            </table>
            <div class="row" style="margin-top:8px">
              <button class="btn primary" data-use="r320gel">Use This Recipe</button>
            </div>
          </div>
        </div>

        <div class="acc" id="acc-elec">
          <h3><span>Electrolyte Blend (“Salt Doggy”)</span><span>▸</span></h3>
          <div class="content">
            <p><span class="badge">Purpose</span> Concentrated electrolyte base. <b>4.8 g</b> delivers ~<b>1000 mg Na</b> (+ K, Ca, Mg). Use standalone or inside gels/drinks.</p>
            <p><b>Why Na/K/Ca/Mg?</b> Sodium replaces sweat Na⁺ and drives glucose-water absorption; Potassium balances intracellular fluid and nerve transmission; Calcium supports muscle contraction and enzyme activity; Magnesium aids muscle relaxation and ATP metabolism.</p>
            <table>
              <thead><tr><th>Mineral / Ingredient</th><th>Role</th><th class="buy">Buy</th></tr></thead>
              <tbody>
                <tr><td>Sodium citrate / Sea salt</td><td>Primary sodium source (+ buffering if citrate)</td><td class="buy"><a href="[[LINK_NACITRATE]]" target="_blank" class="ext">Sodium citrate</a> · <a href="[[LINK_SALT]]" target="_blank" class="ext">Sea salt</a></td></tr>
                <tr><td>Potassium citrate</td><td>Na/K balance; nerve function</td><td class="buy"><a href="[[LINK_PCITRATE]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Calcium carbonate</td><td>Trace Ca for contraction, stability</td><td class="buy"><a href="[[LINK_CACARB]]" target="_blank" class="ext">Amazon</a></td></tr>
                <tr><td>Magnesium sulfate (food grade)</td><td>Mg for relaxation, ATP metabolism</td><td class="buy"><a href="[[LINK_MGSULF]]" target="_blank" class="ext">Amazon</a></td></tr>
              </tbody>
            </table>
            <div class="row" style="margin-top:8px">
              <button class="btn primary" data-use="relec">Use This Blend</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="card">
      <h2>How the Hydrogel Works</h2>
      <p class="chipnote">The 320 system stays fluid in your bottle thanks to <b>sodium bicarbonate</b>, which raises pH and keeps <b>sodium alginate</b> + <b>LM pectin</b> from crosslinking. After you drink it, the stomach’s acid lowers pH and natural calcium ions complete the gel matrix. For a squeeze‑gel variant, you add <b>calcium gluconate</b> yourself to crosslink outside the stomach.</p>
    </div>

  </section>

</div>

<script>
const $ = (q, el=document)=>el.querySelector(q);
const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));

// Tab handling
$$(".tab").forEach(t=>t.onclick=()=>{
  $$(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const id = t.getAttribute("data-tab");
  $$(".section").forEach(s=>s.classList.remove("active"));
  $("#sec-"+id).classList.add("active");
  window.scrollTo({top:0, behavior:"smooth"});
});

// Constants
const NA_PER_G_SALT = 393;           // mg Na per g NaCl
const NA_PER_G_BLEND = 1000/4.8;     // mg Na per g of your electrolyte blend ≈ 208.33 mg/g

// Helpers
function parseRatio(txt){
  const parts = txt.split(":").map(s=>parseFloat(s));
  if(parts.length===2 && parts.every(x=>!isNaN(x))) return parts;
  return [1,0.8];
}
function gfSplit(total, ratioTxt){
  const [g,f] = parseRatio(ratioTxt);
  const sum = g+f; return {g: total * g/sum, f: total * f/sum};
}
function gramsSourceForNa(mgNa, source){
  const mgPerG = (source==="blend") ? NA_PER_G_BLEND : NA_PER_G_SALT;
  return mgNa>0 ? (mgNa / mgPerG) : 0;
}
function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
function hmsToHours(hms){
  const p = hms.split(":").map(Number);
  if(p.length===3) return p[0] + p[1]/60 + p[2]/3600;
  if(p.length===2) return p[0] + p[1]/60;
  return parseFloat(hms) || 2.0;
}

// SCALE logic
function updateScale(){
  const mode = $("#mode").value;
  const cho = +$("#rCHO").value||0;
  const ratio = $("#ratio").value;
  const caf = +$("#rCaf").value||0;
  const gel = $("#gel").value;
  const waterPct = +$("#rWater").value||0;

  const naSource = $("#naSource").value; // 'blend' or 'salt'
  const naPer = +$("#rNa").value||0;
  const naGramsPer = gramsSourceForNa(naPer, naSource);
  $("#rNaGrams").value = fmt(naGramsPer) + " g / unit";
  $("#kNaPer").textContent = fmt(naGramsPer) + " g (" + (naSource==="blend" ? "blend" : "sea salt") + ")";

  const units = +$("#units").value||0;
  const over = (+$("#over").value||0)/100;
  const totalUnits = Math.ceil(units*(1+over));
  const totalNaMg = naPer * totalUnits;
  $("#kNaBatch").textContent = "~ " + totalNaMg.toFixed(0) + " mg";

  let perDesc = "";
  let perServ = [];
  if(mode==="cane"){
    perDesc = `Per serving (cane sugar): ${fmt(cho)} g sugar`;
    perServ.push({name:"Cane Sugar", g: cho});
  } else {
    const split = gfSplit(cho, ratio);
    $("#kSplit").textContent = `${fmt(split.g)}g G/M • ${fmt(split.f)}g F`;
    perDesc = `Per serving: ${fmt(split.g)} g glucose/malto + ${fmt(split.f)} g fructose`;
    perServ.push({name:"Glucose/Malto", g: split.g});
    perServ.push({name:"Fructose", g: split.f});
  }

  if(naPer>0){
    perDesc += ` • ${naPer} mg Na via ${naSource==="blend" ? "electrolyte blend" : "sea salt"} (${fmt(naGramsPer)} g)`;
    perServ.push({name: naSource==="blend" ? "Electrolyte Blend" : "Sea Salt (NaCl)", g: naGramsPer});
  }

  if(caf>0){
    perDesc += ` • ${caf} mg caffeine`;
    perServ.push({name:"Caffeine", g: caf/1000});
  }

  if(gel!=="None"){
    const baseMass = perServ.reduce((a,b)=>a+b.g,0);
    const gelG = baseMass * 0.01; // 1% illustrative
    perDesc += ` • ${gel} (~1% of mix) • Water target ${waterPct}%`;
    perServ.push({name: gel, g: gelG});
  }

  const batch = perServ.map(i=>({name:i.name, g: i.g * Math.ceil(units*(1+over))}));
  let html = `<div><b>Per serving</b>: ${perDesc}</div>
              <div class="hr"></div>
              <div><b>Batch (${Math.ceil(units*(1+over))} units incl. overage)</b></div>
              <ul>`;
  batch.forEach(b=>{ html += `<li>${b.name}: <b>${fmt(b.g)}</b> g</li>`; });
  html += `</ul>`;
  $("#outScale").innerHTML = html;
}
["#mode","#rCHO","#rNa","#rCaf","#ratio","#gel","#rWater","#naSource","#units","#over","#fill"].forEach(sel=>{
  $(sel).addEventListener("input", updateScale);
});
updateScale();

// Combine logic
function updateCombine(){
  const includeSalt = $("#cSalt").checked;
  const includeCaf = $("#cCaf").checked;
  const includeBic = $("#cBicarb").checked;
  const includeGel = $("#cGel").checked;
  const na = +$("#cNa").value||0;
  const caf = +$("#cCafMg").value||0;
  const water = +$("#cWater").value||0;

  let lines = [];
  if(includeSalt && na>0) lines.push(`Electrolyte add: choose source in Scale tab; e.g. blend ${fmt(gramsSourceForNa(na,"blend"))} g or sea salt ${fmt(gramsSourceForNa(na,"salt"))} g per serving`);
  if(includeCaf && caf>0) lines.push(`Caffeine: ${fmt(caf/1000)} g per serving`);
  if(includeBic) lines.push(`Bicarb (for drink): raises pH to delay gelation`);
  if(includeGel) lines.push(`Gelling agent: ~1.0% of per-serving mass; Water target: ${water}%`);
  if(lines.length===0) lines.push("No add-ons selected.");
  $("#outCombine").innerHTML = lines.map(x=>`• ${x}`).join("<br>");
}
["#cSalt","#cCaf","#cBicarb","#cGel","#cNa","#cCafMg","#cWater","#cBase"].forEach(sel=>{
  $(sel).addEventListener("input", updateCombine);
});
updateCombine();

// Race Day logic
$("#rdCompute").onclick=()=>{
  const timeH = hmsToHours($("#rdTime").value.trim());
  const choH = +$("#rdChoH").value||0;
  const naH = +$("#rdNaH").value||0;
  const gels = +$("#rdGels").value||0;
  const perGel = +$("#rdChoPerGel").value||0;
  const totalCHO = choH * timeH;
  const totalNa = naH * timeH;
  const neededGels = perGel>0 ? Math.ceil(totalCHO / perGel) : gels;
  const useGels = gels>0 ? gels : neededGels;

  const naSource = $("#naSource").value;
  const naPerGel = totalNa / useGels;
  const gramsSourcePerGel = gramsSourceForNa(naPerGel, naSource);

  const gelsPerHour = useGels / timeH;
  const achievedChoPerHour = perGel * gelsPerHour;
  const achievedNaPerHour = naPerGel * gelsPerHour;

  const overPct = 0.25;
  const batchGels = Math.ceil(useGels*(1+overPct));
  const totalSourceGrams = gramsSourcePerGel * batchGels;

  let html = `
    <div><b>Race time:</b> ~${timeH.toFixed(2)} h</div>
    <div><b>CHO target:</b> ${totalCHO.toFixed(0)} g total (${choH.toFixed(0)} g/h target)</div>
    <div><b>Na target:</b> ${totalNa.toFixed(0)} mg total (${naH.toFixed(0)} mg/h target)</div>
    <div><b>Plan:</b> ${useGels} gels → ${gelsPerHour.toFixed(2)} gels/hour</div>
    <div><b>Achieved from plan:</b> ~${achievedChoPerHour.toFixed(0)} g CHO/h, ~${achievedNaPerHour.toFixed(0)} mg Na/h</div>
    <div class="hr"></div>
    <div><b>Per gel:</b> ${perGel} g CHO, ~${naPerGel.toFixed(0)} mg Na → ${fmt(gramsSourcePerGel)} g ${naSource==="blend"?"electrolyte blend":"sea salt"}</div>
    <div><b>Create batch:</b> ${batchGels} gels (includes 25% overage)</div>
    <ul>
      <li>Total ${naSource==="blend"?"blend":"sea salt"} for batch: <b>${fmt(totalSourceGrams)}</b> g</li>
      <li>Glucose/Malto + Fructose split per gel follows your Scale tab ratio</li>
      <li>Optional caffeine per gel: set in Scale tab</li>
    </ul>`;
  $("#outRace").innerHTML = html;
};

// Templates / Export
$("#btnTemplates").onclick=()=>{
  alert("Templates:\n• 100-style Gel (24g @ 1:0.8, no sodium)\n• 320-style Drink (80g/500mL)\n• 320-style Gel (25g powder + 15g water)\n• 320-style Bulk Powder\n• Electrolyte Blend\n(Stub in this wireframe)");
};
$("#btnExport").onclick=()=>{
  alert("Export PDF (stub in wireframe).");
};

// Mode toggle
$("#mode").addEventListener("change", e=>{
  $("#ratioRow").style.display = (e.target.value==="cane") ? "none" : "grid";
  updateScale();
});

// Accordion behavior
$$(".acc h3").forEach(h=>{
  h.addEventListener("click", ()=>{
    h.parentElement.classList.toggle("open");
  });
});

// "Use This Recipe" buttons → prefill Scale tab
function goToScale(){ $$(".tab").forEach(x=>x.classList.remove("active")); $$("[data-tab='scale']")[0].classList.add("active"); $$(".section").forEach(s=>s.classList.remove("active")); $("#sec-scale").classList.add("active"); window.scrollTo({top:0, behavior:"smooth"}); updateScale(); }
document.addEventListener("click", (e)=>{
  const btn = e.target.closest("[data-use]"); if(!btn) return;
  const key = btn.getAttribute("data-use");
  if(key==="r100"){
    $("#mode").value="custom"; $("#rCHO").value=24; $("#ratio").value="1 : 0.8"; $("#rNa").value=0; $("#naSource").value="salt"; $("#rCaf").value=0; $("#gel").value="Alginate + Ca"; $("#rWater").value=62.5;
  } else if(key==="r320drink"){
    $("#mode").value="custom"; $("#rCHO").value=80; $("#ratio").value="1 : 0.8"; $("#rNa").value=0; $("#naSource").value="blend"; $("#rCaf").value=0; $("#gel").value="None"; $("#rWater").value=96;
  } else if(key==="r320powder"){
    $("#mode").value="custom"; $("#rCHO").value=80; $("#ratio").value="1 : 0.8"; $("#rNa").value=0; $("#naSource").value="blend"; $("#rCaf").value=0; $("#gel").value="None"; $("#rWater").value=0;
  } else if(key==="r320gel"){
    $("#mode").value="custom"; $("#rCHO").value=25; $("#ratio").value="1 : 0.8"; $("#rNa").value=0; $("#naSource").value="salt"; $("#rCaf").value=0; $("#gel").value="Alginate + Ca"; $("#rWater").value=37.5;
  } else if(key==="relec"){
    $("#mode").value="cane"; $("#rCHO").value=0; $("#rNa").value=1000; $("#naSource").value="blend"; $("#rCaf").value=0; $("#gel").value="None"; $("#rWater").value=0;
  }
  goToScale();
});
</script>
</body>
</html>
